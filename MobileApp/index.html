<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no	initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>Bike Bell app</title>

    <script src="libs/leaflet.js"></script> 
    <script src="libs/jquery/jquery-2.1.4.js"></script>   
	<script src="libs/jquery-mobile/jquery.mobile-1.4.5.js"></script>

    <link rel="stylesheet" href="ui/css/leaflet.css" />
	<link rel="stylesheet" href="libs/jquery-mobile/jquery.mobile-1.4.5.css" />
	<link rel="stylesheet" type="text/css" href="ui/css/fablab.css" />
	
	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) {
		console.log = hyper.log;
	}
	
	var _VERSION = '0.2.6';
	var map;
	var settings = window.localStorage;

	document.addEventListener(
		'DOMContentLoaded',
		function () {
			console.log('===========');
			console.log('Started at ' + formatTimestamp(new Date()));
			logActivity('Application version <strong class="meta version">' + _VERSION + '</strong> loaded :: events will be logged here');

			if (navigator.geolocation) {
				console.log('App supports ' + navigator.geolocation + ', using options: ' + JSON.stringify(config.geoOptions));
				logActivity('Getting GPS fix', 'task');
				navigator.geolocation.getCurrentPosition(

					function(position) {
						logActivity('Location found: (' + position.coords.latitude + ',' + position.coords.longitude + ')');
						startMap( [
							position.coords.latitude,
							position.coords.longitude
							]
						);
						$('#journey-toggle').toggleClass('disabled start');
						$('#journey-toggle').on('click',startJourney);

var TESTWatchId = navigator.geolocation.watchPosition( function(position) {
		console.log('now at (' + position.coords.latitude + ',' + position.coords.longitude + ')');
		if (typeof(mypos) == 'undefined') {
			mypos = L.marker(L.latLng(position.coords.latitude, position.coords.longitude), {icon:L.icon({iconUrl: locationPinIcon})}).addTo(map);
		}
		else {
			mypos.update();
		}
	},
    function(e) {
	    console.log('watch error code: ' + error.code + ' message: ' + error.message);
	},
    config.geoOptions
);

						// displayStatus(); // FIXME: make this a native system notifcation instead
					},

					function(e) {
						logActivity('Location not determined', 'error');
						if (dummyLoc.length) {
							startMap(dummyLoc);
						}
						if (config.enableButtonsWithoutGPS) {
							logActivity('Enabling buttons without GPS as per config');
							$('#journey-toggle').toggleClass('disabled start');
							$('#journey-toggle').on('click',startJourney);
						}
						logActivity('No GPS' + (config.enableButtonsWithoutGPS ? ' (Ready anyway)' : ''), 'error');
					},

					config.geoOptions
				);
			}

			$('.ui-tabs').on('tabsactivate', function(event, ui) {
				// console.log('activated ' + ui.newTab.filter('#nav-map').length);
				ui.newTab.each( function () { // .filter('#nav-map').each
					console.log('Switched tab to ' + $(this).text());
					//L.DomEvent.addListener(window, 'load', startMap);
					// map.invalidateSize(false);
					// console.log(map);
				});

/*
				if ( ui.newTab.attr('id') == 'nav-map') {
					console.log('activated ');
*/
			});

		},
		function() {
			console.log('bummer about the map');
		}
	);

	function startMap(at) {
		map = L.map('track-canvas');

		L.tileLayer(
			'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
			{
				attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
			}
			).addTo(map);

		if (at) {
			console.log('Centering map at ' + JSON.stringify(at));
			map.setView(at, 18);
		}

	}

	$(document).on('pageinit', function() {

		$('.menu-btn').add('.burger.menu li a').click( function() {
			$('.burger.menu').toggleClass('out'); // FIXME: can possibly use https://api.jqueryui.com/theming/stacking-elements/ from the framework instead here
		});

		adaptiveButton('connect');

		// $('#fauxOn').prop('defaultChecked', config.useFauxConnection); - doesn't work :(

		// $('#menu').menu(); // would also be nice to use the JS-UI framework here, but this method from the examples freezes execution and can't find much on it

	});

	</script>

</head>

<body>
	<div data-role="page" data-theme="b">
		<div data-role="header">

			<span class="menu-btn ui-btn ui-btn-left ui-icon-user ui-btn-icon-notext" data-icon="user">User menu</span>

			<h1>Sensibel</h1>

			<div class="mobile-nav"> <!--  style="display:inline-block;position:absolute; right: 20px; z-index:100;" -->
				<a class="menu-btn ui-btn ui-btn-right ui-icon-bars ui-btn-icon-notext" data-icon="bars">Menu</a>
<!--
					<div></div>
					<span></span>
					<span></span>
					<span></span>
				</div>
-->

				<div class="burger menu">
					<ul>
						<li><a href="javascript: switchTab($('#nav-map'));"><img src="ui/images/smico3.png" />Map</a></li>
						<li><a id="menu.settings" href="javascript: showSettings();">Settings</a></li>
					</ul>
<!--
				<menuitem>
					<a id="menu.connect" onclick="connect();">Connect</a>
				</menuitem>
				<menuitem>
					<a id="menu.connect" onclick="console.log('blend on'); app.on();">Blend light ON</a>
				</menuitem>
				<menuitem>
					<a id="menu.connect" onclick="console.log('blend off'); app.off();">Blend light OFF</a>
				</menuitem>
				<menuitem>
					<a href="#about">About</a>
				</menuitem>
				<menuitem>
					<a onclick="navigator.app.exitApp();">Restart</a>
				</menuitem>
-->
					<h3>Somebody FIXME</h3>
					<ul>
						<li><a onclick="SENSOR.disconn();">Disconnect</a></li>
						<li><a onclick="navigator.app.exitApp();">Exit</a></li>
					</ul>
				</div>
			</div>

			<p class="status"><strong class="label">Status: </strong><span id="status">Ready</span></p>

			<div role="main" class="ui-content">
				<div data-role="tabs" class="ui-tabs">
					<div data-role="navbar" class="ui-tabs-nav">
						<ul>
							<li><a href="#panel-logs" class="ui-tabs-anchor">Logs</a></li>
							<li class="ui-tabs-active"><a href="#panel-dash" class="ui-tabs-anchor ui-btn-active">Dashboard</a></li> <!-- FIXME: this option should be default, may be moved to map tab to test map display -->
							<li id="nav-map"><a href="#panel-map" class="ui-tabs-anchor">Map</a></li>
						</ul>
					</div>

					<div id="panel-logs" class="ui-tabs-panel swipeable">

<div data-role="controlgroup" data-type="horizontal" data-shadow="true" data-theme="a" data-corners="true">
	<fieldset>
	<legend>Developer diagnostics</legend>
	<div class="basic tools">
		<input type="button" onclick="basicScan(app.target);" value="Scan" />
		<input type="button" onclick="basicConnect(app.target);" value="Connect" />
		<input type="button" onclick="basicRead(app.target);" value="Read" />
		<input type="button" onclick="basicWrite('BTN_GOOD_FIXME');" style="color:green;" value="Green" />
		<input type="button" disabled="disabled" data-disabled="true" onclick="basicWrite(BTN_BAD_FIXME);" style="color:red;" value="Red" />
		<input type="button" onclick="basicDisconnect(app.target);" value="Disconnect" />
		<input type="button" disabled="disabled" data-disabled="true" onclick="basicCheckStatus(app.target);" value="Check conn" />
		<input type="button" onclick="resetBLE(initSensor);" value="Reset BLE" />

		<label for="fauxOn">BLE</label>
		<!-- NB: this switch won't take effect until next time you connect -->
		<input type="checkbox" onchange="config.useFauxConnection=this.checked;" data-theme="b" id="fauxOn" data-role="flipswitch" data-mini="true" data-on-text="Fake" data-off-text="Real" />
		</div>
	</fieldset>
</div>

						<p id="activities" class="console log" />
					</div>

					<div id="panel-dash" class="ui-tabs-panel swipeable">

<!--
						<div id="banner">
							<a href="#track">
								<img src="fablabchch.png" alt="FAB LAB CHCH" style="float:left;width:100px;height:auto;"/>
							</a>

							<img id="connectButton" src="casing.jpg" onclick="showSettings();" style="float:right;width:120px;height:auto;" />
						</div>
-->

						<ul style="list-item-type:none; display: inline;">
							<li><button id="journey-start" class="start" onclick="startJourney()">Start Journey</button></li>
							<li><button id="journey-end" class="end" onclick="endJourney()">End Journey</button></li>
							<li><button style="display:none;" id="journey-toggle" class="disabled reactive">Start Journey</button></li>
							<li><button id="journey-review" class="disabled reactive">Review Journey</button></li>
						</ul>

<div data-role="controlgroup" data-type="horizontal" class="outer majora">
<input type="button" onclick="connectSensor();" value="Connect" data-wrapper-class="inner majora adaptive connect" id="adaptive-connect" />
<input type="button" onclick="FIXME();" value="Start" data-wrapper-class="inner majora adaptive start" id="adaptive-start" />
</div>
<!--
-->

					</div>

					<div id="panel-map" class="ui-tabs-panel" style="height:100%">
						<!-- <section id="track"> -->
						<div id="track-canvas" class="section map hack"><pre>
Quite
terrible
I
know.
A
spacer
in
the
hackingest
sense
in
stead (yes, 2 words)
of
a
map.
Never
to
be
rendered
or
otherwise
brought
to
light
one
hopes
</pre></div>
<script>
// map.invalidateSize(false);
</script>
						<!-- </section> -->
					</div>
				</div>
			</div>

<!--
			<nav>
				<ul>
					<li id="nav-logs"><a href="#status">Logs</a></li>
					<li id="nav-dash" class="active"><a href="#top">Dashboard</a></li>
					<li id="nav-map"><a href="#track">Map</a></li>
				</ul>
			</nav>
-->		
		</div>

		<!-- <img id="sprite" src="sprite.svg" /> -->

	</div>

	<!-- library code -->
	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<!-- <script src="libs/evothings/tisensortag/tisensortag.js"></script> -->
	<script src="libs/evothings/arduinoble/arduinoble.js"></script>
	<script src="libs/togeojson.js"></script>

	<!-- app inclusions -->
	<script src="config.js"></script>
	<script src="blend.js"></script>
	<!-- <script src="SpriteManager.js"></script> -->
	<!-- <script src="sensor.js"></script> -->
	<script src="sensibell.js"></script>

</body>
</html>
